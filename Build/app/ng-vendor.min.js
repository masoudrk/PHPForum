/*
 sepanta 2018-12-08 
*/
function getPage(a){window.location=a}var appName="myApp",serviceBaseURL="api/public/",app=angular.module(appName,["ngRoute","ngAnimate","toaster","ui.bootstrap","ui.router","fullPage.js","oc.lazyLoad","angular-confirm","ADM-dateTimePicker","ngFileUpload","ui.select","720kb.tooltips","ngCkeditor","treasure-overlay-spinner","cfp.hotkeys","vcRecaptcha","ui.router.title","ngMaterial","ngMessages","material.svgAssetsCache","pageslide-directive","ngCookies"]);app.config(["$stateProvider","$urlRouterProvider","$ocLazyLoadProvider","tooltipsConfProvider","ADMdtpProvider","vcRecaptchaServiceProvider",function(a,b,c,d,e,f){f.setSiteKey("6LcX8F0UAAAAAAsz8wJTigfIcMJQD_mTpXd9UbS5"),d.configure({smart:!0,size:"small",speed:"fast"}),e.setOptions({calType:"jalali",format:"YYYY/MM/DD hh:mm",default:"today"}),c.config({debug:!1,events:!0}),a.state("home",{url:"/",templateUrl:"angular.partial.HomeRoot.html",controller:"DefaultCtrl",abstract:!0,resolve:{deps:["$ocLazyLoad",function(a){return a.load([])}],$title:function(){return"getSiteName"},$isAsyncTitle:function(){return!0}}}).state("home.home",{url:"home",views:{viewContent:{templateUrl:"angular.partial.Main.html",controller:"MainCtrl"}},resolve:{deps:["$ocLazyLoad",function(a){return a.load([])}]}}),b.otherwise(function(a,b){var c=a.get("$state");c.go("home.home")})}]),app.factory("Extention",["$http","$timeout","$rootScope","$state","$stateParams","toaster","$uibModal",function(a,b,c,d,e,f,g){c.userSession=session;var h=serviceBaseURL,i={};return i.workers=0,i.debugMode=!0,i.noImageClass="fa fa-2x fa-user",i.setBusy=function(a){a?(0===i.workers&&(c.spinner.active=!0),i.workers++):(i.workers--,0===i.workers&&b(i.disableLoading,500))},i.toast=function(a){f.pop(a.status,"",a.message,1e4,"trustedHtml")},i.pop=function(a,b,c){c||(c=7e3),f.pop(a,"",b,c,"trustedHtml")},i.popError=function(a,b){b||(b=7e3),f.pop("error","",a,b,"trustedHtml")},i.popSuccess=function(a,b){b||(b=7e3),f.pop("success","",a,b,"trustedHtml")},i.popInfo=function(a,b){b||(b=7e3),f.pop("info","",a,b,"trustedHtml")},i.get=function(b){return i.setBusy(!0),a.get(h+b).then(function(a){return i.setBusy(!1),a.data},function(a){return i.setBusy(!1),a})},i.getExternal=function(b){return i.setBusy(!0),a.get(b).then(function(a){return i.setBusy(!1),a.data},function(a){return i.setBusy(!1),a})},i.post=function(b,c){return i.setBusy(!0),a.post(h+b,c).then(function(a){return i.debugMode&&console.log(a.data),i.setBusy(!1),a.data},function(a){return i.debugMode&&console.log(a.data),i.setBusy(!1),a})},i.postAsync=function(b,c){return a.post(h+b,c).then(function(a){return i.debugMode&&200!=a.status&&i.popModal(a),a.data},function(a){return i.debugMode&&i.popModal(a.data),a})},i.disableLoading=function(){c.spinner.active=!1},i.authUser=function(a){c.authenticated=!0,c.user={},c.user.UserID=a.UserID,c.user.lastName=a.LastName,c.user.firstName=a.FirstName},i.unAuthUser=function(){c.authenticated=!1,c.isAdmin=!1,c.user={}},i.isAdmin=function(){return c.isAdmin},i.getAuth=function(){return{authenticated:c.authenticated,isAdmin:c.isAdmin}},i.openSignupPanel=function(a){var b;b="en"==a?"partials/HomeEN/SignupTemplate.html":"partials/Home/SignupTemplate.html",g.open({animation:!0,templateUrl:b,controller:"authCtrl",size:"md"})},i.openSigninPanel=function(a){var b;b="en"==a?"partials/HomeEN/LoginTemplate.html":"partials/Home/LoginTemplate.html",g.open({animation:!0,templateUrl:b,controller:"authCtrl",size:"md"})},i.scrollTo=function(a){function b(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}var c=b(),d=a,e=d>c?d-c:c-d;if(e<100)return void scrollTo(0,d);var f=Math.round(e/10);f>=5&&(f=5);var g=Math.round(e/25),h=d>c?c+g:c-g,i=0;if(d>c)for(var j=c;j<d;j+=g)setTimeout("window.scrollTo(0, "+h+")",i*f),h+=g,h>d&&(h=d),i++;else for(var j=c;j>d;j-=g)setTimeout("window.scrollTo(0, "+h+")",i*f),h-=g,h<d&&(h=d),i++},i.scrollToElement=function(a,b){function c(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}function d(a){for(var b=document.getElementById(a),c=b.offsetTop,d=b;d.offsetParent&&d.offsetParent!=document.body;)d=d.offsetParent,c+=d.offsetTop;return c}b||(b=0);var e=c(),f=d(a)+b,g=f>e?f-e:e-f;if(g<100)return void scrollTo(0,f);var h=Math.round(g/10);h>=5&&(h=5);var i=Math.round(g/25),j=f>e?e+i:e-i,k=0;if(f>e)for(var l=e;l<f;l+=i)setTimeout("window.scrollTo(0, "+j+")",k*h),j+=i,j>f&&(j=f),k++;else for(var l=e;l>f;l-=i)setTimeout("window.scrollTo(0, "+j+")",k*h),j-=i,j<f&&(j=f),k++},i}]),app.run(["$rootScope","$templateCache","$state","$location","Extention",function(a,b,c,d,e){document.addEventListener("keyup",function(b){27===b.keyCode&&a.$broadcast("escapePressed",b.target)}),document.addEventListener("click",function(b){a.$broadcast("documentClicked",b.target)}),a.spinner={active:!1},a.$on("$stateChangeSuccess",function(){e.setBusy(!1)}),a.$on("$stateChangeStart",function(a,b,c){e.setBusy(!0)})}]),app.filter("propsFilter",function(){return function(a,b){var c=[];if(angular.isArray(a)){var d=Object.keys(b);a.forEach(function(a){for(var e=!1,f=0;f<d.length;f++){var g=d[f],h=b[g].toLowerCase();if(a[g].toString().toLowerCase().indexOf(h)!==-1){e=!0;break}}e&&c.push(a)})}else c=a;return c}}),app.filter("jalaliDate",function(){return function(a,b){var c=moment(a);return c.fromNow()+" "+c.format(b)}}),app.filter("moment",function(){return function(a,b){return moment(a).format(b)}}),app.filter("subString",function(){return function(a,b){return a&&a.length>b?a.substr(0,b)+"...":a}}),app.filter("split",function(){return function(a,b,c){if(!a)return"";for(var d="",e=0;e<a.length;e++)d+=e===a.length-1?a[e][c]:a[e][c]+b;return d}}),app.directive("slideable",function(){return{restrict:"C",compile:function(a,b){var c=a.html();return a.html('<div class="slideable_content" style="margin:0 !important; padding:0 !important" >'+c+"</div>"),function(a,b,c){c.duration=c.duration?c.duration:"1s",c.easing=c.easing?c.easing:"ease-in-out",b.css({overflow:"hidden",height:"0px",transitionProperty:"height",transitionDuration:c.duration,transitionTimingFunction:c.easing})}}}}),app.directive("slideToggle",function(){return{restrict:"A",link:function(a,b,c){var d=document.querySelector(c.slideToggle);c.expanded=!1,b.bind("click",function(){var a=d.querySelector(".slideable_content");if(c.expanded)d.style.height="0px";else{a.style.border="1px solid rgba(0,0,0,0)";var b=a.clientHeight;a.style.border=0,d.style.height=b+"px"}c.expanded=!c.expanded})}}}),app.directive("compile",["$compile",function(a){return function(b,c,d){b.$watch(function(a){return a.$eval(d.compile)},function(d){c.html(d),a(c.contents())(b)})}}]),angular.module("ui.router.title",["ui.router"]).run(["$rootScope","$timeout","$state","Extention",function(a,b,c,d){function e(a){return angular.isFunction(a)?a():a}a.$on("$stateChangeSuccess",function(){var f=c.$current.locals.globals.$title,g=c.$current.locals.globals.$isAsyncTitle;if(g)d.post(f).then(function(d){b(function(){a.$title=d.SiteName}),a.$breadcrumbs=[];for(var f=c.$current;f;)f.resolve&&f.resolve.$title&&a.$breadcrumbs.unshift({title:e(f.locals.globals.$title),state:f.self.name,stateParams:f.locals.globals.$stateParams}),f=f.parent});else{var h=e(f);b(function(){a.$title=h}),a.$breadcrumbs=[];for(var i=c.$current;i;)i.resolve&&i.resolve.$title&&a.$breadcrumbs.unshift({title:e(i.locals.globals.$title),state:i.self.name,stateParams:i.locals.globals.$stateParams}),i=i.parent}})}]),app.controller("authCtrl",["$scope","$rootScope","$state","$routeParams","$uibModalInstance","$location","$http","Extention",function(a,b,c,d,e,f,g,h){a.login={},a.signup={},a.doLogin=function(a){h.post("login",{customer:a}).then(function(a){"success"==a.Status?(h.authUser(a),e.close(a),a.IsAdmin?(h.toast({status:"success",message:"ادمین گرامی به سایت خوش آمدید!"}),c.go("admin_root.dashboard")):(h.toast({status:"success",message:"کاربر گرامی به سایت خوش آمدید!"}),c.go("user_root.dashboard"))):h.toast({status:"error",message:"خطا ، اطلاعات وارد شده نادرست است."})})},a.signup={email:"",password:"",name:"",phone:"",address:""},a.signUp=function(b){return a.checkEmail(b.email)?!b.username||b.username.length<5?void h.popError("نام کاربری بایستی حداقل 5 کارکتر باشد!"):!b.password||b.password.length<5?void h.popError("رمز وارد شده بایستی حداقل 5 کاراکتر باشد!"):b.password!=b.password2?void h.popError("رمز وارد شده با تایید آن یکسان نیست!"):void h.post("signUp",{customer:b,recaptchaResponse:a.myRecaptchaResponse}).then(function(a){a&&"success"==a.Status?(e.close(a),h.authUser(a),h.toast({status:"success",message:"ثبت نام با موفقیت انجام شد!"})):"error-exists"==a.Status?h.toast({status:"error",message:"کاربری با این مشخصات ثبت نام کرده است!"}):"error-captcha"==a.Status?h.toast({status:"error",message:"هویت شما شناخته نشد ، لطفا دوباره امتحان کنید."}):h.toast({status:"error",message:"خطا ، لطفا دوباره تلاش کنید."})}):void h.popError("ایمیل وارد شده معتبر نیست!")},a.checkEmail=function(b){return a.EMAIL_REGEXP.test(b)},a.EMAIL_REGEXP=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,a.ok=function(){e.close(a.selected.item)},a.cancel=function(){e.dismiss("cancel")}}]),angular.module("myApp").controller("DefaultCtrl",["$scope","$templateCache","$state","$rootScope","$routeParams","$uibModal","Extention",function(a,b,c,d,e,f,g){}]),angular.module("myApp").controller("MainCtrl",["$scope","$templateCache","$state","$rootScope","$routeParams","$uibModal","Extention","$cookies",function(a,b,c,d,e,f,g,h){g.postAsync("checkPopUp",{}).then(function(a){return void console.log(a)}),a.user={},a.emailError=!1,a.userNameError=!1,a.userNameRegex=/[أ-ي]/,a.allPositions=[],a.Position={},g.postAsync("getAllPositions",{}).then(function(b){a.allPositions=b}),a.checkEmail=function(b){b&&g.postAsync("checkEmail",{value:b}).then(function(b){"success"===b.Status?(a.emailError=!b.Data,a.emailError&&g.popError("این ایمیل قبلا ثبت شده است")):g.popError("خطا در ارتباط")})},a.openRoleModal=function(){f.open({animation:!0,templateUrl:"myModalContent.html",controller:["$scope","$uibModalInstance",function(a,b){a.ok=function(){b.close(a.selected.item)},a.cancel=function(){b.dismiss("cancel")}}],size:"md"})},a.savePerson=function(){a.user.roleAccepted&&a.signUpForm.$valid&&!a.user.emailError?(a.user.OrganizationID=a.Position.selected.ID,g.post("savePerson",a.user).then(function(b){console.log(b),"success"===b.Status?(a.user={},g.popSuccess("اطلاعات شما با موفقیت ثبت شد .لطفا ایمیل خود را بررسی کنید. ",1e4)):"emailError"===b.Status?g.popError("این ایمیل قبلا ثبت شده است"):g.popError("اطلاعات شما نا معتبر است")})):a.signUpForm.name.$valid?g.popError("لطفا تمام اطلاعات را وارد کنید"):g.popError("لطفا نام خودرا فارسی وارد کنید")},a.logInUser=function(){getPage("Forum/home.php")},a.signOutUser=function(){g.post("logout",{}).then(function(a){d.userSession={}})},a.signInFunc=function(){a.signInForm.$valid&&g.post("signInUser",a.signIn).then(function(a){"success"===a.Status?getPage(a.IsAdmin?"Admin":"Forum/home.php"):"notAccepted"===a.Status?g.popError("اکانت شما هنوز  توسط ادمین تایید نشده است"):(console.log(a),g.popError("اطلاعات شما نا معتبر است."))})},a.mainOptions={anchors:["firstPage"],menu:"#menu"},a.openForgetPassModal=function(){f.open({animation:!0,templateUrl:"passModal.html",controller:["$scope","$uibModalInstance",function(a,b){a.sentPassToEmail=function(){a.Email&&g.post("forgetPassword",{Email:a.Email}).then(function(a){"success"===a.Status?g.popSuccess("پسورد جدید برای ایمیل شما ارسال شده است"):(console.log(a),g.popError("اطلاعات شما نا معتبر است."))})},a.cancel=function(){b.dismiss("cancel")}}],size:"md"})}}]);